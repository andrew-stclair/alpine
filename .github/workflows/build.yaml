name: Get Alpine
on:
  workflow_dispatch:

jobs:
  alpine:
    strategy:
      max-parallel: 1
      matrix:
        include:
          - MMR: 3.19.1
            MM: 3.19
          - MMR: 3.19.0
            MM: 3.19
    runs-on: ubuntu-latest
    container: alpine:latest

    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000
        options: >-
          --health-cmd "curl -f http://localhost:5000/ || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Pre-Reqs
        run: |
          apk update
          apk add docker docker-cli docker-cli-buildx curl

      - name: Import
        run: |
          docker import --platform aarch64 --message "Import tarball from alpine" --change "ENTRYPOINT /bin/ash" --change "ENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" https://dl-cdn.alpinelinux.org/alpine/v${{ matrix.MM }}/releases/aarch64/alpine-minirootfs-${{ matrix.MMR }}-aarch64.tar.gz registry:5000/alpine:${{ matrix.MMR }}-aarch64
          docker import --platform armhf   --message "Import tarball from alpine" --change "ENTRYPOINT /bin/ash" --change "ENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" https://dl-cdn.alpinelinux.org/alpine/v${{ matrix.MM }}/releases/armhf/alpine-minirootfs-${{ matrix.MMR }}-armhf.tar.gz     registry:5000/alpine:${{ matrix.MMR }}-armhf
          docker import --platform armel   --message "Import tarball from alpine" --change "ENTRYPOINT /bin/ash" --change "ENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" https://dl-cdn.alpinelinux.org/alpine/v${{ matrix.MM }}/releases/armv7/alpine-minirootfs-${{ matrix.MMR }}-armv7.tar.gz     registry:5000/alpine:${{ matrix.MMR }}-armel
          docker import --platform ppc64le --message "Import tarball from alpine" --change "ENTRYPOINT /bin/ash" --change "ENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" https://dl-cdn.alpinelinux.org/alpine/v${{ matrix.MM }}/releases/ppc64le/alpine-minirootfs-${{ matrix.MMR }}-ppc64le.tar.gz registry:5000/alpine:${{ matrix.MMR }}-ppc64le
          docker import --platform s390x   --message "Import tarball from alpine" --change "ENTRYPOINT /bin/ash" --change "ENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" https://dl-cdn.alpinelinux.org/alpine/v${{ matrix.MM }}/releases/s390x/alpine-minirootfs-${{ matrix.MMR }}-s390x.tar.gz     registry:5000/alpine:${{ matrix.MMR }}-s390x
          docker import --platform i386    --message "Import tarball from alpine" --change "ENTRYPOINT /bin/ash" --change "ENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" https://dl-cdn.alpinelinux.org/alpine/v${{ matrix.MM }}/releases/x86/alpine-minirootfs-${{ matrix.MMR }}-x86.tar.gz         registry:5000/alpine:${{ matrix.MMR }}-i386
          docker import --platform x86_64  --message "Import tarball from alpine" --change "ENTRYPOINT /bin/ash" --change "ENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" https://dl-cdn.alpinelinux.org/alpine/v${{ matrix.MM }}/releases/x86_64/alpine-minirootfs-${{ matrix.MMR }}-x86_64.tar.gz   registry:5000/alpine:${{ matrix.MMR }}-x86_64

      - name: Push
        run: |
          docker push registry:5000/alpine:${{ matrix.MMR }}-aarch64
          docker push registry:5000/alpine:${{ matrix.MMR }}-armhf
          docker push registry:5000/alpine:${{ matrix.MMR }}-armel
          docker push registry:5000/alpine:${{ matrix.MMR }}-ppc64le
          docker push registry:5000/alpine:${{ matrix.MMR }}-s390x
          docker push registry:5000/alpine:${{ matrix.MMR }}-i386
          docker push registry:5000/alpine:${{ matrix.MMR }}-x86_64
      
      - name: Cleanup
        run: |
          docker image rm registry:5000/alpine:${{ matrix.MMR }}-aarch64
          docker image rm registry:5000/alpine:${{ matrix.MMR }}-armhf
          docker image rm registry:5000/alpine:${{ matrix.MMR }}-armel
          docker image rm registry:5000/alpine:${{ matrix.MMR }}-ppc64le
          docker image rm registry:5000/alpine:${{ matrix.MMR }}-s390x
          docker image rm registry:5000/alpine:${{ matrix.MMR }}-i386
          docker image rm registry:5000/alpine:${{ matrix.MMR }}-x86_64

      - name: Merge
        run: |
          docker buildx imagetools create \
            registry:5000/alpine:${{ matrix.MMR }}-aarch64 \
            registry:5000/alpine:${{ matrix.MMR }}-armhf \
            registry:5000/alpine:${{ matrix.MMR }}-armel \
            registry:5000/alpine:${{ matrix.MMR }}-ppc64le \
            registry:5000/alpine:${{ matrix.MMR }}-s390x \
            registry:5000/alpine:${{ matrix.MMR }}-i386 \
            registry:5000/alpine:${{ matrix.MMR }}-x86_64 \
            -t registry:5000/alpine:${{ matrix.MMR }}